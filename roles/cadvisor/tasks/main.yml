---
- name: Create cAdvisor directories
  file:
    path: /opt/cadvisor
    state: directory
    mode: '0755'

- name: Run cAdvisor container
  community.docker.docker_container:
    name: cadvisor
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    state: started
    restart_policy: unless-stopped
    ports:
      - "9080:8080"
    volumes:
      - "/:/rootfs:ro"
      - "/var/run:/var/run:ro"
      - "/sys:/sys:ro"
      - "/var/lib/docker:/var/lib/docker:ro"
      - "/dev/disk:/dev/disk:ro"
    privileged: true
    devices:
      - "/dev/kmsg:/dev/kmsg"
    command: >
      --docker_only=true
      --housekeeping_interval=30s
      --enable_metrics=disk,network,cpu,memory
  register: cadvisor_container

- name: Wait for cAdvisor to be ready
  wait_for:
    host: localhost
    port: 9080
    timeout: 60
  when: cadvisor_container.changed

- name: Show cAdvisor status
  debug:
    msg: "cAdvisor running at http://{{ ansible_host }}:9080/metrics"